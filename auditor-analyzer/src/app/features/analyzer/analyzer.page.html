<div class="container mt-3">
  <h2>Document Analyzer for Auditors</h2>

  <section id="upload" class="card p-3 mb-3">
    <h3 class="h5">Upload / Paste Data</h3>
    <div style="display:flex; gap:1rem; align-items:flex-start; flex-wrap:wrap;">
      <div style="flex:1; min-width:280px;">
        <label><strong>Paste CSV</strong></label>
        <textarea class="form-control" rows="10" (input)="onCsvTextChange(($any($event.target)?.value) ?? '')" placeholder="period,revenue,netIncome,assets,liabilities...\n2024-Q1,120000,15000,500000,300000"></textarea>
        <div class="mt-2" *ngIf="isLoadingParse()"><div class="spinner-border spinner-border-sm" role="status"></div> Parsing...</div>
      </div>
      <div style="display:flex; flex-direction:column; gap:0.5rem; min-width:240px;">
        <label><strong>Upload file</strong></label>
        <input type="file" class="form-control" (change)="onFileSelected($event)" accept=".csv,.xlsx,.xls,.pdf" />
        <label><strong>Paste raw text</strong></label>
        <textarea class="form-control" rows="5" (input)="onRawTextChange(($any($event.target)?.value) ?? '')" placeholder="Paste text from audit report, financial statements, or tax filings..."></textarea>
        <button type="button" class="btn btn-primary" (click)="classifyAndAnalyzeRawText()" [disabled]="isLoadingAi()">Classify & Analyze Text</button>
        <div class="mt-2" *ngIf="isLoadingAi()"><div class="spinner-border spinner-border-sm" role="status"></div> Analyzing...</div>
      </div>
    </div>
  </section>

  <section id="exec" class="card p-3 mb-3">
    <h3 class="h5" (click)="execExpanded.set(!execExpanded())">1. Executive Summary</h3>
    <div *ngIf="analysis()?.executiveSummary && execExpanded() as exec">
      <p><strong>Purpose:</strong> {{ analysis()!.executiveSummary.purpose }}</p>
      <p><strong>Reporting period:</strong> {{ analysis()!.executiveSummary.reportingPeriod }}</p>
      <p><strong>Key highlights:</strong> Rev {{ analysis()!.executiveSummary.keyHighlights.revenue }} | NI {{ analysis()!.executiveSummary.keyHighlights.netIncome }} | A {{ analysis()!.executiveSummary.keyHighlights.assets }} | L {{ analysis()!.executiveSummary.keyHighlights.liabilities }}</p>
      <ul>
        <li *ngFor="let c of analysis()!.executiveSummary.majorChanges">{{ c }}</li>
      </ul>
    </div>
  </section>

  <section id="metrics" class="card p-3 mb-3">
    <h3 class="h5" (click)="metricsExpanded.set(!metricsExpanded())">2. Financial Metrics & Ratios</h3>
    <div *ngIf="analysis() && metricsExpanded()">
      <ul>
        <li><strong>Gross margin:</strong> {{ (analysis()!.financialMetrics.profitability.grossMargin ?? 0) | number:'1.2-2' }}</li>
        <li><strong>Net margin:</strong> {{ (analysis()!.financialMetrics.profitability.netMargin ?? 0) | number:'1.2-2' }}</li>
        <li><strong>ROE:</strong> {{ (analysis()!.financialMetrics.profitability.returnOnEquity ?? 0) | number:'1.2-2' }}</li>
        <li><strong>Current ratio:</strong> {{ (analysis()!.financialMetrics.liquidity.currentRatio ?? 0) | number:'1.2-2' }}</li>
        <li><strong>Quick ratio:</strong> {{ (analysis()!.financialMetrics.liquidity.quickRatio ?? 0) | number:'1.2-2' }}</li>
        <li><strong>Debt-to-equity:</strong> {{ (analysis()!.financialMetrics.solvency.debtToEquity ?? 0) | number:'1.2-2' }}</li>
        <li><strong>Interest coverage:</strong> {{ (analysis()!.financialMetrics.solvency.interestCoverage ?? 0) | number:'1.2-2' }}</li>
        <li><strong>Inventory turnover:</strong> {{ (analysis()!.financialMetrics.efficiency.inventoryTurnover ?? 0) | number:'1.2-2' }}</li>
        <li><strong>Receivables turnover:</strong> {{ (analysis()!.financialMetrics.efficiency.receivablesTurnover ?? 0) | number:'1.2-2' }}</li>
      </ul>
    </div>
  </section>

  <section id="risk" class="card p-3 mb-3">
    <h3 class="h5" (click)="riskExpanded.set(!riskExpanded())">3. Compliance & Risk Indicators</h3>
    <div *ngIf="analysis() && riskExpanded()">
      <p><strong>Missing/Inconsistent:</strong></p>
      <ul>
        <li *ngFor="let x of analysis()!.complianceAndRisk.missingOrInconsistent">{{ x }}</li>
      </ul>
      <p><strong>Unusual transactions:</strong></p>
      <ul>
        <li *ngFor="let x of analysis()!.complianceAndRisk.unusualTransactions">{{ x }}</li>
      </ul>
      <p><strong>Late filings/delays:</strong></p>
      <ul>
        <li *ngFor="let x of analysis()!.complianceAndRisk.lateFilingsOrDelays">{{ x }}</li>
      </ul>
      <p><strong>Non-compliance notes:</strong></p>
      <ul>
        <li *ngFor="let x of analysis()!.complianceAndRisk.nonComplianceNotes">{{ x }}</li>
      </ul>
    </div>
  </section>

  <section id="trends" class="card p-3 mb-3">
    <h3 class="h5" (click)="trendsExpanded.set(!trendsExpanded())">4. Trend Analysis</h3>
    <div *ngIf="trendsExpanded()">
      <ag-charts [options]="chartOptions()"></ag-charts>
    </div>
  </section>

  <section id="anomalies" class="card p-3 mb-3">
    <h3 class="h5" (click)="anomaliesExpanded.set(!anomaliesExpanded())">5. Anomaly Detection</h3>
    <div *ngIf="analysis() && anomaliesExpanded()">
      <ul>
        <li *ngFor="let n of analysis()!.anomalies.notes">{{ n }}</li>
      </ul>
    </div>
  </section>

  <section id="structure" class="card p-3 mb-3">
    <h3 class="h5" (click)="structureExpanded.set(!structureExpanded())">6. Document Structure Insights</h3>
    <div *ngIf="analysis() && structureExpanded()">
      <ul>
        <li *ngFor="let t of analysis()!.structure.tableOfContents">
          <a [href]="'#' + t.anchor">{{ t.title }}</a>
        </li>
      </ul>
      <p><strong>Glossary:</strong> {{ analysis()!.structure.glossary.join(', ') }}</p>
    </div>
  </section>

  <section id="highlights" class="card p-3 mb-3">
    <h3 class="h5" (click)="highlightsExpanded.set(!highlightsExpanded())">7. Audit-Relevant Highlights</h3>
    <div *ngIf="analysis() && highlightsExpanded()">
      <p><strong>Judgment areas:</strong></p>
      <ul><li *ngFor="let x of analysis()!.auditHighlights.areasRequiringJudgment">{{ x }}</li></ul>
      <p><strong>Estimates & assumptions:</strong></p>
      <ul><li *ngFor="let x of analysis()!.auditHighlights.estimatesAndAssumptions">{{ x }}</li></ul>
      <p><strong>Internal controls:</strong></p>
      <ul><li *ngFor="let x of analysis()!.auditHighlights.internalControlDisclosures">{{ x }}</li></ul>
      <p *ngIf="analysis()!.auditHighlights.auditorsOpinion"><strong>Auditor's opinion:</strong> {{ analysis()!.auditHighlights.auditorsOpinion }}</p>
    </div>
  </section>

  <section id="links" class="card p-3 mb-3">
    <h3 class="h5" (click)="linksExpanded.set(!linksExpanded())">8. Supporting Document Links</h3>
    <div *ngIf="analysis() && linksExpanded()">
      <ul>
        <li *ngFor="let l of analysis()!.supportingLinks"><a [href]="l.href" target="_blank" rel="noopener">{{ l.description || l.href }}</a></li>
      </ul>
    </div>
  </section>

  <section id="ai" class="card p-3 mb-3">
    <h3 class="h5" (click)="aiExpanded.set(!aiExpanded())">AI-Powered Suggestions</h3>
    <div *ngIf="analysis() && aiExpanded()">
      <ul>
        <li *ngFor="let s of analysis()!.aiSuggestions"><strong>{{ s.question }}</strong><span *ngIf="s.rationale"> â€” {{ s.rationale }}</span></li>
      </ul>
      <div *ngIf="aiMessages().length">
        <h4 class="h6">Agent Responses</h4>
        <div #acContainer></div>
      </div>
    </div>
  </section>
</div>

