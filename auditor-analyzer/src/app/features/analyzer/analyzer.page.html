<div class="container mt-3">
  <h2>Document Analyzer for Auditors</h2>

  <section id="upload" class="card p-3 mb-3">
    <h3 class="h5">Upload / Paste Data</h3>
    <div style="display:flex; gap:1rem; align-items:flex-start; flex-wrap:wrap;">
      <div style="flex:1; min-width:280px;">
        <label><strong>Paste CSV</strong></label>
        <textarea class="form-control" rows="10" (input)="onCsvTextChange(($any($event.target)?.value) ?? '')" placeholder="period,revenue,netIncome,assets,liabilities...\n2024-Q1,120000,15000,500000,300000"></textarea>
        <div class="mt-2" *ngIf="isLoadingParse()"><div class="spinner-border spinner-border-sm" role="status"></div> Parsing...</div>
      </div>
      <div style="display:flex; flex-direction:column; gap:0.5rem; min-width:240px;">
        <label><strong>Upload file</strong></label>
        <input type="file" class="form-control" (change)="onFileSelected($event)" accept=".csv,.xlsx,.xls,.pdf" />
        <label><strong>Analyze from URL</strong></label>
        <div class="input-group">
          <input type="url" class="form-control" placeholder="https://..." #urlInput>
          <button class="btn btn-outline-secondary" type="button" (click)="onAnalyzeUrl(urlInput.value)">Fetch & Analyze</button>
        </div>
        <label><strong>Paste raw text</strong></label>
        <textarea class="form-control" rows="5" (input)="onRawTextChange(($any($event.target)?.value) ?? '')" placeholder="Paste text from audit report, financial statements, or tax filings..."></textarea>
        <button type="button" class="btn btn-primary" (click)="classifyAndAnalyzeRawText()" [disabled]="isLoadingAi()">Classify & Analyze Text</button>
        <div class="mt-2" *ngIf="isLoadingAi()"><div class="spinner-border spinner-border-sm" role="status"></div> Analyzing...</div>
      </div>
    </div>
  </section>

  <section id="exec" class="card p-3 mb-3">
    <h3 class="h5" (click)="execExpanded.set(!execExpanded())">1. Executive Summary</h3>
    <div *ngIf="analysis()?.executiveSummary && execExpanded() as exec">
      <p><strong>Purpose:</strong> {{ analysis()!.executiveSummary.purpose }}</p>
      <p><strong>Reporting period:</strong> {{ analysis()!.executiveSummary.reportingPeriod }}</p>
      <p><strong>Key highlights:</strong> Rev {{ analysis()!.executiveSummary.keyHighlights.revenue }} | NI {{ analysis()!.executiveSummary.keyHighlights.netIncome }} | A {{ analysis()!.executiveSummary.keyHighlights.assets }} | L {{ analysis()!.executiveSummary.keyHighlights.liabilities }}</p>
      <ul>
        <li *ngFor="let c of analysis()!.executiveSummary.majorChanges">{{ c }}</li>
      </ul>
    </div>
  </section>

  <section id="metrics" class="card p-3 mb-3">
    <h3 class="h5" (click)="metricsExpanded.set(!metricsExpanded())">2. Financial Metrics & Ratios</h3>
    <div *ngIf="analysis() && metricsExpanded()">
      <ul>
        <li><strong>Gross margin:</strong> {{ (analysis()!.financialMetrics.profitability.grossMargin ?? 0) | number:'1.2-2' }}</li>
        <li><strong>Net margin:</strong> {{ (analysis()!.financialMetrics.profitability.netMargin ?? 0) | number:'1.2-2' }}</li>
        <li><strong>ROE:</strong> {{ (analysis()!.financialMetrics.profitability.returnOnEquity ?? 0) | number:'1.2-2' }}</li>
        <li><strong>Current ratio:</strong> {{ (analysis()!.financialMetrics.liquidity.currentRatio ?? 0) | number:'1.2-2' }}</li>
        <li><strong>Quick ratio:</strong> {{ (analysis()!.financialMetrics.liquidity.quickRatio ?? 0) | number:'1.2-2' }}</li>
        <li><strong>Debt-to-equity:</strong> {{ (analysis()!.financialMetrics.solvency.debtToEquity ?? 0) | number:'1.2-2' }}</li>
        <li><strong>Interest coverage:</strong> {{ (analysis()!.financialMetrics.solvency.interestCoverage ?? 0) | number:'1.2-2' }}</li>
        <li><strong>Inventory turnover:</strong> {{ (analysis()!.financialMetrics.efficiency.inventoryTurnover ?? 0) | number:'1.2-2' }}</li>
        <li><strong>Receivables turnover:</strong> {{ (analysis()!.financialMetrics.efficiency.receivablesTurnover ?? 0) | number:'1.2-2' }}</li>
      </ul>
    </div>
  </section>

  <section id="risk" class="card p-3 mb-3">
    <h3 class="h5" (click)="riskExpanded.set(!riskExpanded())">3. Compliance & Risk Indicators</h3>
    <div *ngIf="analysis() && riskExpanded()">
      <p><strong>Missing/Inconsistent:</strong></p>
      <ul>
        <li *ngFor="let x of analysis()!.complianceAndRisk.missingOrInconsistent">{{ x }}</li>
      </ul>
      <p><strong>Unusual transactions:</strong></p>
      <ul>
        <li *ngFor="let x of analysis()!.complianceAndRisk.unusualTransactions">{{ x }}</li>
      </ul>
      <p><strong>Late filings/delays:</strong></p>
      <ul>
        <li *ngFor="let x of analysis()!.complianceAndRisk.lateFilingsOrDelays">{{ x }}</li>
      </ul>
      <p><strong>Non-compliance notes:</strong></p>
      <ul>
        <li *ngFor="let x of analysis()!.complianceAndRisk.nonComplianceNotes">{{ x }}</li>
      </ul>
    </div>
  </section>

  <section id="trends" class="card p-3 mb-3">
    <h3 class="h5" (click)="trendsExpanded.set(!trendsExpanded())">4. Trend Analysis</h3>
    <div *ngIf="trendsExpanded()">
      <ag-charts [options]="chartOptions()"></ag-charts>
    </div>
  </section>

  <section id="anomalies" class="card p-3 mb-3">
    <h3 class="h5" (click)="anomaliesExpanded.set(!anomaliesExpanded())">5. Anomaly Detection</h3>
    <div *ngIf="analysis() && anomaliesExpanded()">
      <ul>
        <li *ngFor="let n of analysis()!.anomalies.notes">{{ n }}</li>
      </ul>
    </div>
  </section>

  <section id="structure" class="card p-3 mb-3">
    <h3 class="h5" (click)="structureExpanded.set(!structureExpanded())">6. Document Structure Insights</h3>
    <div *ngIf="analysis() && structureExpanded()">
      <ul>
        <li *ngFor="let t of analysis()!.structure.tableOfContents">
          <a [href]="'#' + t.anchor">{{ t.title }}</a>
        </li>
      </ul>
      <p><strong>Glossary:</strong> {{ analysis()!.structure.glossary.join(', ') }}</p>
    </div>
  </section>

  <section id="highlights" class="card p-3 mb-3">
    <h3 class="h5" (click)="highlightsExpanded.set(!highlightsExpanded())">7. Audit-Relevant Highlights</h3>
    <div *ngIf="analysis() && highlightsExpanded()">
      <p><strong>Judgment areas:</strong></p>
      <ul><li *ngFor="let x of analysis()!.auditHighlights.areasRequiringJudgment">{{ x }}</li></ul>
      <p><strong>Estimates & assumptions:</strong></p>
      <ul><li *ngFor="let x of analysis()!.auditHighlights.estimatesAndAssumptions">{{ x }}</li></ul>
      <p><strong>Internal controls:</strong></p>
      <ul><li *ngFor="let x of analysis()!.auditHighlights.internalControlDisclosures">{{ x }}</li></ul>
      <p *ngIf="analysis()!.auditHighlights.auditorsOpinion"><strong>Auditor's opinion:</strong> {{ analysis()!.auditHighlights.auditorsOpinion }}</p>
    </div>
  </section>

  <section id="links" class="card p-3 mb-3">
    <h3 class="h5" (click)="linksExpanded.set(!linksExpanded())">8. Supporting Document Links</h3>
    <div *ngIf="analysis() && linksExpanded()">
      <ul>
        <li *ngFor="let l of analysis()!.supportingLinks"><a [href]="l.href" target="_blank" rel="noopener">{{ l.description || l.href }}</a></li>
      </ul>
    </div>
  </section>

  <section id="ai" class="card p-3 mb-3">
    <h3 class="h5" (click)="aiExpanded.set(!aiExpanded())">AI-Powered Suggestions</h3>
    <div *ngIf="analysis() && aiExpanded()">
      <ul>
        <li *ngFor="let s of analysis()!.aiSuggestions"><strong>{{ s.question }}</strong><span *ngIf="s.rationale"> â€” {{ s.rationale }}</span></li>
      </ul>
      <div class="row">
        <div class="col-md-4">
          <h4 class="h6">Questions to Ask</h4>
          <ul>
            <li *ngFor="let q of (analysis()!.aiQuestions || [])">{{ q }}</li>
          </ul>
        </div>
        <div class="col-md-4">
          <h4 class="h6">Deeper Investigation</h4>
          <ul>
            <li *ngFor="let d of (analysis()!.deeperInvestigations || [])">{{ d }}</li>
          </ul>
        </div>
        <div class="col-md-4">
          <h4 class="h6">Risks & Opportunities</h4>
          <div class="d-flex gap-4">
            <ul class="mb-0">
              <li *ngFor="let r of (analysis()!.risks || [])">Risk: {{ r }}</li>
            </ul>
            <ul class="mb-0">
              <li *ngFor="let o of (analysis()!.opportunities || [])">Opportunity: {{ o }}</li>
            </ul>
          </div>
        </div>
      </div>
      <div *ngIf="aiMessages().length">
        <h4 class="h6">Agent Responses</h4>
        <div #acContainer></div>
      </div>
    </div>
  </section>

  <section id="actions" class="card p-3 mb-3">
    <div class="d-flex align-items-center justify-content-between">
      <h3 class="h5 mb-0">Auditor Action Items</h3>
      <button type="button" class="btn btn-sm btn-outline-primary" (click)="addActionItem()">Add</button>
    </div>
    <div class="mt-3" *ngIf="actionItems().length; else noItems">
      <div *ngFor="let item of actionItems()" class="border rounded p-2 mb-2">
        <div class="d-flex gap-2 align-items-center">
          <input class="form-check-input" type="checkbox" [checked]="item.completed" (change)="updateActionItem(item.id, { completed: $any($event.target).checked })">
          <input class="form-control form-control-sm" [value]="item.title" (input)="updateActionItem(item.id, { title: $any($event.target).value })" placeholder="Action title">
          <select class="form-select form-select-sm" [value]="item.priority || 'Medium'" (change)="updateActionItem(item.id, { priority: $any($event.target).value })" style="max-width:120px;">
            <option>Low</option>
            <option>Medium</option>
            <option>High</option>
          </select>
          <input class="form-control form-control-sm" type="date" [value]="item.dueDate || ''" (change)="updateActionItem(item.id, { dueDate: $any($event.target).value })" style="max-width:160px;">
          <input class="form-control form-control-sm" [value]="item.owner || ''" (input)="updateActionItem(item.id, { owner: $any($event.target).value })" placeholder="Owner" style="max-width:160px;">
          <button type="button" class="btn btn-sm btn-outline-danger" (click)="removeActionItem(item.id)">Remove</button>
        </div>
        <textarea class="form-control form-control-sm mt-2" rows="2" [value]="item.notes || ''" (input)="updateActionItem(item.id, { notes: $any($event.target).value })" placeholder="Notes"></textarea>
      </div>
    </div>
    <ng-template #noItems>
      <p class="text-muted mb-0">No action items yet. Click Add to create tasks.</p>
    </ng-template>
  </section>
</div>

